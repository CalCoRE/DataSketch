{"version":3,"sources":["modules/datasketch/canvas/view.coffee"],"names":[],"mappings":"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","file":"modules/datasketch/canvas/view.js","sourceRoot":"/source/","sourcesContent":["define (require) ->\n  $ = require 'jquery'\n  DomView = require 'core/view/dom_view'\n  Globals = require 'core/model/globals'\n  Template = require 'text!./view.html'\n\n  Group = require './objects/group/object'\n\n  Fabric = require 'thirdparty/fabric'\n  require 'link!./style.css'\n\n  class DSCanvasView extends DomView\n    constructor: (model) ->\n      super Template\n      model.addEventListener 'Model.Change', @_onChange\n      model.addEventListener 'Canvas.ObjectRemoved', @_onObjectRemoved\n      model.addEventListener 'Canvas.ObjectAdded', @_onObjectAdded\n      model.addEventListener 'Canvas.ObjectsRemoved', @_onObjectsRemoved\n      model.addEventListener 'Canvas.ObjectsAdded', @_onObjectsAdded\n\n    initCanvas: (model) =>\n      @_fabric = new Fabric.Canvas @$el.find('.canvas-main')[0]\n      @_fabric.isDrawingMode = true\n      @_fabric.on 'path:created', @_onPathCreated\n      @_fabric.on 'object:selected', @_onObjectSelected\n      @_fabric.on 'selection:created', @_onSelectionCreated\n      @_fabric.on 'before:selection:cleared', @_beforeSelectionCleared\n      @_fabric.on 'selection:cleared', @_onSelectionCleared\n      Globals.get('Relay').addEventListener 'Window.Resize', @updateDimensions\n      @updateDimensions()\n\n    render: (model) =>\n      if @_fabric?\n        @_fabric.clear()\n        @_renderObjects model.get('objects'), model.get('isolated')\n        @_fabric.discardActiveGroup()\n        @_fabric.renderAll()\n\n    dryRender: () =>\n      @_fabric.renderAll()\n\n    _renderObjects: (objects, isolations) =>\n      for obj in objects\n        @_fabric.discardActiveGroup()\n        if obj in isolations\n          @_renderObjects obj.getObjects(), isolations\n        else\n          if obj instanceof Group\n            @_fabric.setActiveGroup obj.view().getFabric()\n          obj.enforceTransform()\n          @_fabric.add obj.view().getFabric()\n\n    _onPathCreated: (evt) =>\n      @dispatchEvent 'Path.Created',\n        path: evt.path\n\n    _onSelectionCreated: (evt) =>\n      @_fabricSelection = evt.target\n      @_fabricSelectionMetaCache =\n        position:\n          x: @_fabricSelection.left\n          y: @_fabricSelection.top\n        rotation: @_fabricSelection.angle\n        scale:\n          x: @_fabricSelection.scaleX\n          y: @_fabricSelection.scaleY\n      @_fabricSelection.on 'modified', @_onSelectionModified\n      @dispatchEvent 'Selection.Created',\n        objectIds: (obj.get('id') for obj in evt.target.getObjects())\n\n    _beforeSelectionCleared: (evt) =>\n      @_fabricSelection?.off 'modified', @_onSelectionModified\n      @_fabricSelection = null\n\n    _onSelectionModified: (evt) =>\n      if @_fabricSelection?\n        delta =\n          position:\n            x: @_fabricSelection.left - @_fabricSelectionMetaCache.position.x\n            y: @_fabricSelection.top - @_fabricSelectionMetaCache.position.y\n          rotation: @_fabricSelection.angle - @_fabricSelectionMetaCache.rotation\n          scale:\n            x: @_fabricSelection.scaleX - @_fabricSelectionMetaCache.scale.x\n            y: @_fabricSelection.scaleY - @_fabricSelectionMetaCache.scale.y\n        @dispatchEvent 'Selection.Modified',\n          delta: delta\n\n    _onSelectionCleared: (evt) =>\n      @dispatchEvent 'Selection.Cleared', {}\n\n    _onObjectSelected: (evt) =>\n      if group = @_fabric.getActiveGroup()\n        objects = group.getObjects()\n      else\n        objects = [@_fabric.getActiveObject()]\n\n      @dispatchEvent 'Selection.Created',\n        objectIds: (obj.get('id') for obj in objects)\n\n    updateDimensions: () =>\n      @_fabric.setDimensions\n        width: $(window).width()\n        height: $(window).height()\n\n    clearSelection: () =>\n      @_fabric.deactivateAllWithDispatch().renderAll()\n\n    _onChange: (evt) =>\n      switch evt.data.path\n        when \"mode\"\n          @_onChangeMode evt.data.value\n        when \"strokeWidth\"\n          @_fabric.freeDrawingBrush.width = evt.data.value\n          @_fabric.renderAll()\n        when \"strokeColor\"\n          @_fabric.freeDrawingBrush.color = evt.data.value\n          @_fabric.renderAll()\n        when \"selected\"\n          if evt.data.value?.length == 0\n            @clearSelection()\n          # else if !@_fabric.getActiveGroup()?\n          #   @_fabric.setActiveGroup new fabric.Group (obj.get('view') for obj in evt.data.value)\n        when \"isolated\"\n          @render evt.currentTarget\n        when \"disabled\"\n          @_fabric.selection = !evt.data.value\n          @render evt.currentTarget\n\n    _onChangeMode: (val) =>\n      switch val\n        when \"draw\"\n          @_fabric.isDrawingMode = true\n        else\n          @_fabric.isDrawingMode = false\n\n    _onObjectRemoved: (evt) =>\n      @clearSelection()\n\n    _onObjectAdded: (evt) =>\n\n    _onObjectsRemoved: (evt) =>\n      @clearSelection()\n\n    _onObjectsAdded: (evt) =>\n"]}